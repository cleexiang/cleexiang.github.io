# Cordova原理解析以及在供应链中的实践

## 背景介绍

### Cordova是做什么的
> Cordova是一种跨平台的技术，它提供了一种套JavaScript和Native之间的通信的API接口，通过插件的形式，扩展你的应用，让开发者在iOS和安卓等其他设备中通过尽可能少的代码中实现同样的功能。
 
### 比较于其他的跨平台框架，它有怎样的优势和劣势

* 配置简单，易于上手，代码基本有web端实现。
* 框架成熟稳定。
* 相比较ReactNative，性能稍差。

### 我们选择Cordova的原因
* 开发成本低，工作量集中在前端的UI实现，可复用代码极高。
* 随时更新。
* 前端开发人员有cordova开发经验。

## Cordova的使用

### 从零创建一个cordova工程

*  安装cordova命令行工具: `npm install -g cordova`
*  创建app: `cordova create hello com.example.hello HelloWorld`
*  添加平台: `cordova platform add ios`
*  添加插件: `cordova plugin add cordova-plugin-camera`

### 在已有Native工程中添加Corodova

* [iOS官方文档](https://cordova.apache.org/docs/en/latest/guide/platforms/ios/webview.html)
* [Android官方文档](https://cordova.apache.org/docs/en/latest/guide/platforms/android/webview.html)

## Cordova运行的原理	

### 官方架构图	
![](https://cordova.apache.org/static/img/guide/cordovaapparchitecture.png)

### Cordova插件调用逻辑



## 遇到的问题

### Token怎么共享？

* iOS通过NSURLProtocol实现HTTP请求拦截，并修改请求头，添加token数据。
* Android通过覆写Webview的shouldInterceptRequest方法，拦截请求，并将token数据添加到请求头中。

### 怎么实现Native的专场效果？

为了让用户体验更佳，我们采用了实现接近于原生的转场效果，以iOS为例，android实现类似。

1. 前端调用YTNavigation插件的navigate方法，传入html页面的相对地址（注意：不是绝对地址）。
2. 将文件本地地址传入CDVViewController, webview会去加载本地的html，js文件，YTNavigation插件再去调用原生的转场动画。

### 怎么实现热更新？

1. 前端每次发版会有一个version字段作为唯一标识，并将该version字段和web压缩包
发布到运营后台。
2. app每次启动的时候会带着本地保存的version去后台查询是否有包更新，如果有更新，就从服务器下载到本地，并解压到本地目录，并记录version。

### 多模块多版本设计

由于前端代码可能由多个独立模块组成，这样前端最后生成的包有多个，但是cordova默认只支持一个www目录，所以我们引入了多模块的设计：

1. 为每一个模块分配一个ModuleId，每个ModuleId执行独立的包下载，安装流程。
2. 每个模块的存放于独立的目录，在每次跳转页面的时候会先找到模块所在的目录，再拼接文件的本地地址。

如图：

### 持续优化中

1. 实现增量更新，该功能已经在开发中。
2. 对图片等资源做缓存处理，可以极大提升用户体验。

### 调试技巧

* `Charles` 借助charles进行抓包，抓取http请求。
* `Web Inspector` 借助safari自带的web检查器，可以动态调试JavaScript，但是只能在开发阶段调试。

## 参考资料

* [Cordova官方网站](https://cordova.apache.org)
* [iOS实现实现HTTP拦截器](https://cleexiang.github.io/2017-07-26/iOS%E5%AE%9E%E7%8E%B0HTTP%E6%8B%A6%E6%88%AA%E5%99%A8/)
* [Safari动态调试Javascript](https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/Web_Inspector_Tutorial/Introduction/Introduction.html#//apple_ref/doc/uid/TP40017576-CH1-SW1)

#### 感谢邓铃波、李环冀前端同学的支持



	

